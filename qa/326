#! /bin/sh
# PCP QA Test No. 326
# Check PMCD state change notification, aka PMCD reset
#
# Copyright (c) 1995-2002 Silicon Graphics, Inc.  All Rights Reserved.
# Copyright (c) 2016 Red Hat, Inc.
#

seq=`basename $0`
echo "QA output created by $seq"

# get standard filters
. ./common.product
. ./common.filter
. ./common.check

signal=$PCP_BINADM_DIR/pmsignal
status=1
done_clean=false
LOCALHOST=`hostname`

_cleanup()
{
    if $done_clean
    then
	:
    else
	_restore_config $PCP_PMCDCONF_PATH
	_service pcp restart 2>&1 | _filter_pcp_start
	_wait_for_pmcd
	rm -f $tmp.*
	done_clean=true
    fi
    exit $status
}

$sudo rm -rf $tmp.* $seq.full 
trap "_cleanup" 0 1 2 3 15
timezone=`pmprobe -v pmcd.timezone | $PCP_AWK_PROG '{print $3}'`

_filter_host()
{
    # filter this, as we now fetch pmcd.hostname, sneakily
    sed \
	-e "/   value \"$REALHOST\"/d" \
	-e "/   value \"$LOCALHOST\"/d"
}

_filter_pmval()
{
    sed \
	-e '1,/^interval:/d' \
	-e 's/[0-9][0-9]:[0-9][0-9]:[0-9][0-9]\.[0-9][0-9]*[0-9]/TIMESTAMP/g' \
    | $PCP_AWK_PROG '
/No values available/	{ print; next }
0 <= $2 && $2 < 1.1	{ $2 = "non-negative number, less than 1.1" }
			{  print }' \
    | uniq
}

trap "_cleanup" 0 1 2 3 15

_save_config $PCP_PMCDCONF_PATH

rm -f $seq.full

# real QA test starts here
PMDA_PMCD_PATH=$PCP_PMDAS_DIR/pmcd/pmda_pmcd.$DSO_SUFFIX

# start from a known starting point
_service pcp stop >/dev/null 2>&1

cat <<End-of-File >$tmp.tmp
# Installed by PCP QA test $seq on `date`
pmcd	2	dso	pmcd_init	$PMDA_PMCD_PATH
sample	29	pipe	binary 		$PCP_PMDAS_DIR/sample/pmdasample -d 29 
End-of-File
$sudo cp $tmp.tmp $PCP_PMCDCONF_PATH

_service pcp restart 2>&1 | _filter_pcp_start
_wait_for_pmcd

cat <<End-of-File >$tmp.config
log mandatory on 500 msec { pmcd.numagents sample.milliseconds }
End-of-File

# run pmlogger and pmval for 15 seconds
pmlogger -s 30 -l $tmp.log -c $tmp.config $tmp &
pmval -s 30 -t 0.5 -Z "$timezone" -D fetch pmcd.numagents >$tmp.pmval 2>&1 &

sleep 2

echo "=== kill sample PMDA process ==="
$sudo $signal -a -s TERM pmdasample
sleep 2 # enough time for pmcd to restart it - once only
$sudo $signal -a -s TERM pmdasample
sleep 2 # and again

echo "=== SIGHUP PMCD ==="
$sudo $signal -a -s HUP pmcd
sleep 2

echo "=== drop sample PMDA, like Remove ==="
cat <<End-of-File >$tmp.tmp
# Installed by PCP QA test $seq on `date`
pmcd	2	dso	pmcd_init	$PMDA_PMCD_PATH
End-of-File
$sudo cp $tmp.tmp $PCP_PMCDCONF_PATH
$sudo $signal -a -s HUP pmcd
sleep 2

echo "=== add sample PMDA, like Install ==="
cat <<End-of-File >$tmp.tmp
# Installed by PCP QA test $seq on `date`
pmcd	2	dso	pmcd_init	$PMDA_PMCD_PATH
sample	29	pipe	binary 		$PCP_PMDAS_DIR/sample/pmdasample -d 29 
End-of-File
$sudo cp $tmp.tmp $PCP_PMCDCONF_PATH
$sudo $signal -a -s HUP pmcd
sleep 2

wait

echo >>$seq.full
echo "pmcd log ..." >>$seq.full
cat $PCP_PMCDLOG_PATH >>$seq.full

echo
echo "Trace of observed state changes and PMDA count ..."
egrep '(state changes)|( value )' $tmp.pmval \
| _filter_host \
| uniq

echo >>$seq.full
echo "pmlogger log ..." >>$seq.full
cat $tmp.log >>$seq.full

echo
echo "archive contents ..."
pmdumplog $tmp >$tmp.out 2>&1
egrep '(<mark>)|(pmcd.numagents)' $tmp.out \
| _filter_pmdumplog \
| uniq

# note clip after 4 filtered lines to avoid extra values that sometimes
# appear due to non-determinism in pmlogger fetch samples
#
echo
echo "sanity check with pmval | filter ..."
pmval -t 1 -a $tmp sample.milliseconds 2>&1 \
| _filter_pmval \
| sed -e 4q

echo >>$seq.full
echo "unfiltered pmval live output" >>$seq.full
cat $tmp.pmval >>$seq.full

echo >>$seq.full
echo "unfiltered pmval archive output" >>$seq.full
pmval -t 1 -a $tmp sample.milliseconds >>$seq.full 2>&1

status=0
exit
