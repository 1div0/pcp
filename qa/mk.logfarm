#!/bin/sh
#
# create a forest of archives suitable for using with pmlogger_daily
#
# only arg from the command line is the root of the forest, which must
# already exist
#

if [ $# -ne 1 ]
then
    echo "Usage: $0 rootdir"
    exit 1
fi

rootdir="$1"

if [ ! -d "$rootdir" ]
then
    echo "$0: Error: rootdir ($rootdir) does not exist"
    exit 1
fi

cat <<End-of-File | sed -e 's/#.*//' -e '/^[ 	]*$/d' | while read host src dst
thishost	archives/foo+	20011002
thishost	archives/foo+	20011003
thishost	archives/foo+	20011004.01.02
thishost	archives/foo+	20011004.03.04
thishost	archives/foo+	20011004.05.06
thishost	archives/foo+	20011004.05.06-00
thishost	archives/foo+	20011004.07.08
thishost	archives/foo+	20011005
thishost	archives/foo+	20011006.00.10
thishost	archives/foo+	20011007
otherhost	archives/ok-foo	20011002.00.10
otherhost	archives/ok-foo	20011002.00.10-00
otherhost	archives/ok-foo	20011002.02.03
otherhost	archives/ok-foo	20011002.03.04
otherhost	archives/ok-foo	20011003.00.10
otherhost	archives/ok-foo	20011004
otherhost	archives/ok-foo	20011005.00.10
otherhost	archives/ok-foo	20011006
End-of-File
do
    if [ ! -d "$rootdir"/"$host" ]
    then
	if mkdir "$rootdir"/"$host"
	then
	    :
	else
	    echo "$0: Error: mkdir failed for $rootdir/$host"
	    exit 1
	fi
    fi

    for file in "$src".*
    do
	cp "$file" "$rootdir"/"$host"
    done
    srcbase="`basename $src`"

    pmlogmv "$rootdir"/"$host"/"$srcbase" "$rootdir"/"$host"/"$dst"

    # now align the timestamps of the archive with the date-and-time
    # of the destination archive name
    #
    delta=`src/timeshift -z -a "$rootdir"/"$host"/"$dst" "$dst"`
    cat <<End-of-File >$tmp.config
GLOBAL {
    time -> $delta
}
End-of-File
    pmlogrewrite -c $tmp.config -i "$rootdir"/"$host"/"$dst"

    # and finally change the access and modification times
    #
    stamp=`echo "$dst" | sed -e 's/\./ /g' -e 's/\./:/' -e 's/-.*//'`
    for file in "$rootdir"/"$host"/"$dst".*
    do
	touch -d $stamp "$file"
    done

done

exit 0
