- name: Configure agent scale set
  hosts: localhost
  roles:
    - agent_scale_set

- name: Sync build artifacts to test agents
  hosts: localhost
  tasks:
    - name: Download artifacts from build host to controller
      command: >
        rsync -a -e 'ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
        {{ hostvars[hostvars.localhost.build_host].ansible_user }}@{{ hostvars[hostvars.localhost.build_host].ansible_host }}:artifacts/ artifacts/

    - name: Upload artifacts from controller to agents
      command: >
        rsync -a -e 'ssh -o StrictHostKeyChecking=no -o UserKnownHostsFile=/dev/null'
        artifacts/ {{ hostvars[item].ansible_user }}@{{ hostvars[item].ansible_host }}:artifacts/
      loop: "{{ groups[hostvars.localhost.scale_set_group] | difference(hostvars.localhost.build_host) }}"

- name: Run PCP QA suite
  hosts: "{{ hostvars.localhost.scale_set_group }}"
  max_fail_percentage: 0
  roles:
    - test
