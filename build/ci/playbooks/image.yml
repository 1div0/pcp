- name: Prepare agent image
  hosts: localhost
  roles:
    - image

- name: Provision image builder VM
  hosts: "{{ hostvars.localhost.image_builder_host | default(omit) }}"
  tasks:
    - import_role:
        name: provision
      when: hostvars.localhost.build_image

- name: Build agent image
  hosts: "{% if hostvars.localhost.build_image %}localhost{% else %}{{ omit }}{% endif %}"
  tasks:
    - import_role:
        name: image
        tasks_from: build_image
      when: build_image
