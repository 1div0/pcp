# after deprovisioning the machine isn't reachable anymore
# therefore always delete the VM if any error occurs after deprovisioning
- name: Deprovision, generalize and create image from running virtual machine
  block:
    - name: Deprovision virtual machine
      shell: sleep 3; waagent -force -deprovision+user
      async: 1 # deprovisioning will remove user and close SSH connections
      poll: 0
      become: yes
      delegate_to: "{{ image_builder_host }}"

    - name: Generalize virtual machine
      azure_rm_virtualmachine:
        resource_group: "{{ resource_group }}"
        name: "{{ image_builder_host }}"
        generalized: true

    - name: Create an image from a virtual machine
      azure_rm_image:
        resource_group: "{{ resource_group }}"
        name: "{{ image_name }}"
        source: "{{ image_builder_host }}"
        tags:
          pcp_commit: "{{ pcp_commit | default(omit) }}"

  always:
    - name: Remove the VM and all resources that were autocreated
      azure_rm_virtualmachine:
        resource_group: "{{ resource_group }}"
        name: "{{ image_builder_host }}"
        remove_on_absent: all_autocreated
        state: absent
